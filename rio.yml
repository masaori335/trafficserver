schemaVersion: '2.0'

<<: &build_machine
  machine:
    baseImage: docker.apple.com/edge/trafficserver_build:20230321-2-el7

<<: &test_machine
  machine:
    baseImage: docker.apple.com/edge/trafficserver_autest:20230322-1-el7

<<: &build_machine_el9
  machine:
    baseImage: docker.apple.com/edge/trafficserver_build:20230607-1-el9 

timeout: 60

#########
# 9.2.x
#########
builds:
- branchName: 9.2.x
  group: release
  version: all
  <<: *build_machine
  build:
    template: freestyle:v4:publish
    steps:
    - echo "There's nothing to do on this pipeline itself."
  trigger:
    gitPush: false
  finally:
    tag:
      enabled: false
    pipelineChain:
      - pipeline: release-9.2.x-publish-regular
      - pipeline: release-9.2.x-publish-variant
        buildArguments:
          - name: "variation"
            value: "asan"
      - pipeline: release-9.2.x-publish-variant
        buildArguments:
          - name: "variation"
            value: "debug"
      - pipeline: release-9.2.x-publish-variant
        buildArguments:
          - name: "variation"
            value: "boringssl"
  jenkins:
    concurrentBuild: true

- branchName: 9.2.x
  group: release
  version: regular
  <<: *build_machine
  build:
    template: freestyle:v4:publish
    steps:
    - ./apple/rio.sh --build --branch 9.2.x --variation -llvm --tagbuild
  trigger:
    gitPush: false
  finally:
    tag:
      enabled: false
    pipelineChain:
      - pipeline: test-9.2.x-publish-autest
  secrets:
    names:
    - TRAFFICSERVER
  package:
    freeform:
      - publish:
        - repo: yum:cdn-edge
  jenkins:
    concurrentBuild: true

- branchName: 9.2.x
  group: release
  version: regular-el9
  <<: *build_machine_el9
  build:
    template: freestyle:v4:publish
    steps:
    - ./apple/rio.sh --build --branch 9.2.x --variation -llvm --tagbuild
  trigger:
    gitPush: false
  finally:
    tag:
      enabled: false
  secrets:
    names:
    - TRAFFICSERVER
  package:
    freeform:
      - publish:
        - repo: yum:cdn-edge
  jenkins:
    concurrentBuild: true

- branchName: 9.2.x
  group: release
  version: variant
  <<: *build_machine
  build:
    template: freestyle:v4:publish
    buildParameters:
    - parameter: variation
      defaultValue: llvm
      description: Build variation [llvm (deault), asan, io_uring, or debug]
    steps:
    - ./apple/rio.sh --build --branch 9.2.x --variation -${BUILD_PARAM_variation}
  trigger:
    gitPush: false
  finally:
    tag:
      enabled: false
    pipelineChain:
      - pipeline: test-9.2.x-publish-autest
        buildArguments:
          - name: "variation"
            value: ${BUILD_PARAM_variation}
  package:
    freeform:
      - publish:
        - repo: yum:cdn-edge
  jenkins:
    concurrentBuild: true

- branchName: 9.2.x
  group: intpr
  <<: *build_machine
  build:
    template: freestyle:v4:publish
    buildParameters:
    - parameter: pr_id
      description: Internal GitHub PR ID to build
    - parameter: variation
      defaultValue: llvm
      description: Build variation [llvm (deault), asan, io_uring, or debug]
    steps:
    - ./apple/rio.sh --build --branch 9.2.x --prid ${BUILD_PARAM_pr_id} --variation -${BUILD_PARAM_variation}
  trigger:
    gitPush: false
  finally:
    tag:
      enabled: false
  package:
    freeform:
      - publish:
        - repo: yum:cdn-edge
  jenkins:
    concurrentBuild: true

- branchName: 9.2.x
  group: test
  version: autest-all
  <<: *build_machine
  build:
    buildParameters:
    - parameter: test_filter
      description: Tests to run
      defaultValue: '*'
    template: freestyle:v4:publish
    steps:
    - echo "There's nothing to do on this pipeline itself."
  trigger:
    timer: '@daily'
    gitPush: false
  finally:
    tag:
      enabled: false
    pipelineChain:
      - pipeline: test-9.2.x-publish-autest
        buildArguments:
          - name: "variation"
            value: "llvm"
      - pipeline: test-9.2.x-publish-autest
        buildArguments:
          - name: "variation"
            value: "boringssl"
  jenkins:
    concurrentBuild: true

- branchName: 9.2.x
  group: test
  version: autest
  <<: *test_machine
  build:
    buildParameters:
    - parameter: variation
      defaultValue: llvm
      description: Build variation [llvm (deault), asan, io_uring, or debug]
    - parameter: test_filter
      description: Tests to run
      defaultValue: '*'
    template: freestyle:v4:publish
    steps:
    - ./apple/rio.sh --test --branch 9.2.x --variation -${BUILD_PARAM_variation} -f "${BUILD_PARAM_test_filter}"
  reports:
    junit:
      paths:
      - "**/.out/*.xml"
  trigger:
    gitPush: false
  finally:
    tag:
      enabled: false
  jenkins:
    concurrentBuild: true

- branchName: 9.2.x
  group: test
  version: unittest
  <<: *build_machine
  build:
    template: freestyle:v4:prb
    steps:
    - ./apple/rio.sh --build --branch 9.2.x --variation -llvm --prb
  finally:
    notify:
      pullRequestComment:
        postOnSuccess: false
        postOnFailure: false
  jenkins:
    concurrentBuild: true

- branchName: 9.2.x
  group: test
  version: unittest-el9
  <<: *build_machine_el9
  build:
    template: freestyle:v4:prb
    steps:
    - ./apple/rio.sh --build --branch 9.2.x --variation -llvm --prb
  finally:
    notify:
      pullRequestComment:
        postOnSuccess: false
        postOnFailure: false
  jenkins:
    concurrentBuild: true

- branchName: 9.2.x
  group: test
  version: autest
  <<: *test_machine
  build:
    template: freestyle:v4:prb
    steps:
    - ./apple/rio.sh --test --branch 9.2.x --variation -llvm
  finally:
    notify:
      pullRequestComment:
        postOnSuccess: false
        postOnFailure: false
  reports:
    junit:
      paths:
      - "**/.out/*.xml"
    logs:
      paths:
      - "_sandbox/**"
  jenkins:
    concurrentBuild: true

- branchName: 9.2.x
  group: test
  version: unittest-boringssl
  <<: *build_machine
  build:
    template: freestyle:v4:prb
    steps:
    - ./apple/rio.sh --build --branch 9.2.x --variation -boringssl --prb
  finally:
    notify:
      pullRequestComment:
        postOnSuccess: false
        postOnFailure: false
  jenkins:
    concurrentBuild: true

- branchName: 9.2.x
  group: test
  version: autest-boringssl
  <<: *test_machine
  build:
    template: freestyle:v4:prb
    steps:
    - ./apple/rio.sh --test --branch 9.2.x --variation -boringssl
  finally:
    notify:
      pullRequestComment:
        postOnSuccess: false
        postOnFailure: false
  reports:
    junit:
      paths:
      - "**/.out/*.xml"
    logs:
      paths:
      - "_sandbox/**"
  jenkins:
    concurrentBuild: true
